<?xml version="1.0"?>
  <database name="FUNCTION TEGIDL_PRECIOSORDINICIALES">
    <function name="TEGIDL_PRECIOSORDINICIALES" type="NULL">
      <parameter name="p_client_id" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <body><![CDATA[v_id VARCHAR(32);
CUR_ORDENES RECORD;
v_cuenta NUMBER;
  
BEGIN

v_cuenta = 0;

FOR CUR_ORDENES IN
(
SELECT *,
       ROUND(PRECIOINICIAL -(PRECIO_NUEVO*(1 -(DESCUENTO / 100))),2) AS DIFERENCIA,
       ROUND(PRECIO_NUEVO*(1 -(DESCUENTO / 100)),2) AS PRECIO2
FROM (SELECT C_ORDERLINE_ID,
             OL.M_PRODUCT_ID,
             ROUND(PRICEACTUAL,2) AS PRECIOINICIAL,
             ROUND(PP.PRICELIST,2) AS PRECIO_NUEVO,
             DOCUMENTNO,
             ROUND(vtadist_descuentocomercial (O.C_BPARTNER_ID,OL.M_PRODUCT_ID),2) AS DESCUENTO,
             P.name
      FROM C_ORDER O
        INNER JOIN C_ORDERLINE OL 
                ON O.C_ORDER_ID = OL.C_ORDER_ID
               AND UPPER (DOCUMENTNO) LIKE '%INICIAL%'
               AND ISSOTRX = 'N'
               AND O.AD_CLIENT_ID = p_client_id
        INNER JOIN M_PRICELIST_VERSION PLV
                ON PLV.M_PRICELIST_ID = O.M_PRICELIST_ID
               AND PLV.ISACTIVE = 'Y'
        INNER JOIN M_PRODUCTPRICE PP
                ON PLV.M_PRICELIST_VERSION_ID = PP.M_PRICELIST_VERSION_ID
               AND OL.M_PRODUCT_ID = PP.M_PRODUCT_ID
        INNER JOIN M_PRODUCT P ON P.M_PRODUCT_ID = OL.M_PRODUCT_ID) A
WHERE ROUND(PRECIOINICIAL,2) <> ROUND(PRECIO_NUEVO*(1 - (DESCUENTO / 100)),2)

)

LOOP
v_cuenta = v_cuenta + 1;
DBMS_OUTPUT.PUT_LINE( 'DOCUMENTO> ' || CUR_ORDENES.DOCUMENTNO || ' -- PRECIO ORIGINAL >' || CUR_ORDENES.PRECIOINICIAL || ' -- PRECIO DE LISTA >' || CUR_ORDENES.PRECIO2 || ' -- DIFERENCIA >' || CUR_ORDENES.DIFERENCIA || ' -- DESCUENTO >' || CUR_ORDENES.DESCUENTO || ' -- CUENTA >' || v_cuenta);
UPDATE C_ORDERLINE SET PRICEACTUAL = CUR_ORDENES.PRECIO2 WHERE C_ORDERLINE_ID = CUR_ORDENES.C_ORDERLINE_ID;
END LOOP;

RETURN;


EXCEPTION WHEN OTHERS THEN
  DBMS_OUTPUT.PUT_LINE(SQLERRM) ;
  RAISE;
END TEGIDL_PRECIOSORDINICIALES
]]></body>
    </function>
  </database>
